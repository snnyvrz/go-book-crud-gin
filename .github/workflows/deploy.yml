name: Deploy ShelfShare

on:
    workflow_run:
        workflows: ["CI"]
        types:
            - completed

permissions:
    contents: read
    packages: write

env:
    IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/shelfshare-books-api
    IMAGE_TAG: ${{ github.sha }}
    DEPLOY_DIR: /opt/shelfshare

jobs:
    build-and-push:
        name: Build & Push Docker Image
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.25.4"

            - name: Generate Swagger docs
              working-directory: apps/books-api
              run: |
                  go run github.com/swaggo/swag/cmd/swag@latest \
                    init \
                      -d cmd/server,internal/handler,internal/model,internal/validation \
                      -o internal/docs

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ secrets.GHCR_USERNAME }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push books-api image
              uses: docker/build-push-action@v6
              with:
                  context: ./apps/books-api
                  file: ./apps/books-api/Dockerfile
                  push: true
                  tags: |
                      ${{ env.IMAGE_NAME }}:latest
                      ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    deploy:
        name: Deploy to Server
        runs-on: ubuntu-latest
        needs: build-and-push

        steps:
            - name: Checkout repo (for docker-compose.prod.yml)
              uses: actions/checkout@v4

            - name: Copy docker-compose.prod.yml to server
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "docker-compose.prod.yml"
                  target: "${{ env.DEPLOY_DIR }}"

            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      set -e

                      DEPLOY_DIR="${{ env.DEPLOY_DIR }}"
                      BOOKS_API_IMAGE="${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

                      echo "Using DEPLOY_DIR=$DEPLOY_DIR"
                      echo "Using BOOKS_API_IMAGE=$BOOKS_API_IMAGE"

                      # Ensure deploy directory and letsencrypt folder exist
                      sudo mkdir -p "$DEPLOY_DIR/letsencrypt"
                      sudo chown -R $USER:$USER "$DEPLOY_DIR"

                      cd "$DEPLOY_DIR"

                      echo "Logging in to GHCR..."
                      echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

                      echo "Pulling image..."
                      docker pull "$BOOKS_API_IMAGE"

                      echo "Starting containers with docker compose..."
                      BOOKS_API_IMAGE="$BOOKS_API_IMAGE" \
                        docker compose \
                          --env-file .env.prod \
                          -f docker-compose.prod.yml \
                          up -d --remove-orphans

                      echo "Pruning old images..."
                      docker image prune -af || true

                      echo "Waiting for internal service on :8080..."

                      for i in {1..60}; do
                        if curl -fs http://localhost:8080/ready > /dev/null; then
                          echo "Internal service is healthy."
                          break
                        fi
                        echo "Attempt $i: not ready yet..."
                        sleep 1
                      done

                      if [ $i -eq 60 ]; then
                        echo "Internal health check FAILED after 60 seconds"
                        exit 1
                      fi

                      echo "Waiting for external endpoint https://api.shelfshare.space/ready..."

                      for i in {1..60}; do
                        if curl -fs --insecure https://api.shelfshare.space/ready > /dev/null; then
                          echo "External service is healthy."
                          break
                        fi
                        echo "Attempt $i: external endpoint not ready yet..."
                        sleep 1
                      done

                      if [ $i -eq 60 ]; then
                        echo "External health check FAILED after 60 seconds"
                        exit 1
                      fi

                      echo "Deployment successful! Service is healthy."
